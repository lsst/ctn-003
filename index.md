# Configuring the PTP setting on the MOXA network switch

```{abstract}
This document describes how to configure the PTP on the MOXA network switch in the Camera to prevent accidental gap in the motion profile, which left "Raised Alert MOTION (Check of motion profile using Hall data.)" in a shutter log file.
```

## Introduction
The shutter system of the LSST Camera utilizes hall sensors and motor encoders to measure the blade positions. During the testing period and the initial phase of operation following the Precise Time Protocol's implementation, a gap of approximately 10 milliseconds was observed. This document outlines the configuration, test outcomes, recommendations, and potential further optimization strategies. 

## Configuration
The Sonoma Network Time Server, equipped with a PTP/IEEE-1588 system, has been deployed at the Vera C. Rubin Observatory. This device receives GPS signals and utilizes the Precise Timing Protocol (PTP) to transport precise clocks over the Camera network. The Sonoma device functions as a Grandmaster in this network.

The Camera network comprises at least two network switches:
- the Leaf network switch
- the Moxa network switch.
The Leaf switch is configured as a Boundary clock.

The PTP client in the Camera is the Beckoff EL6688 device. This device supports a 100Mbps network, while all other networks accessible from the Moxa switch are 1Gbps.

The objective is to achieve a consistent millisecond time synchronization using PTP from GPS in a heterogeneous speed environment. 

## Analysis

We conducted a series of measurements to assess the Mean Path Delay for 1000 iterations using `readPtpDiag.sh`, employing three distinct configurations:

- **Moxa as Boundary Clock:** In this configuration, the Moxa serves as the primary clock source.
- **Moxa as Transparent Clock:** In this configuration, the Moxa functions as a transparent clock, facilitating the conversion between 100Mbps and 1Gbps.
- **Leaf Switch as Boundary Clock:** In this configuration, the Leaf Switch assumes the role of the boundary clock.

The Moxa as Boundary Clock configuration exhibited significant jitter, reaching a value of 1.2ms. This high jitter is likely the root cause of the MOTION alert. Conversely, the Moxa as Transparent Clock configuration demonstrated minimal jitter, with a value of 0.1ms. The Leaf Switch configuration, while offering a low jitter of 0.0001ms, does not account for the delay introduced by the Moxa.

While the accuracy of 0.1ms may not be the primary concern, it is worth noting that the motion profiles indicate a mean time tick of 4.06 msec and a standard deviation of 3.57 msec. Therefore, a slight deviation from this accuracy level is unlikely to have a significant impact on the overall performance.

## Recommendation
Based on these observations, it is recommended to adopt the Transparent Clock mode for the Moxa. This adjustment will be implemented in the moxa1 setting in the near future.

## Further tuning
If a jitter of 0.1 milliseconds becomes a concern, we could further optimize the network by:
- Prioritizing PTP packets on the Camera network using QoS
- Separating PTP packets to a different VLAN
This is especially important as the QoS solution might confuse the jGroups network traffic, which is the Camera control communication. Constructing a dedicated PTP VLAN is more likely to be a solution.

## Details
Here is a explanation generated by Notebook LM supplying the Moxa manual and Beckoff manual. 
NotebookLM with EL6688 and Moxa manual explains this like:  
Setting your Moxa switch to Transparent Clock (TC) mode instead of Boundary Clock (BC) mode is generally beneficial for reducing jitter when converting PTP packets from a 1Gbps upstream to a 100Mbps downstream for your EL6688 device. This preference stems from the fundamental operational differences between these two types of IEEE 1588 Precision Time Protocol (PTP) clocks.

---

### Understanding PTP and the EL6688

PTP (Precision Time Protocol) is a standard protocol for synchronizing distributed clocks within a network. The goal is to synchronize all PTP clocks to a single, most accurate clock known as the Grandmaster Clock.  
The EL6688 is a 1-Port Communication Interface that supports IEEE 1588/PTP and can function as either a PTP master or slave. It supports both PTPv1 (IEEE 1588-2002) and PTPv2 (IEEE 1588-2008).

---

### Boundary Clock (BC) Operation and Potential Jitter Introduction

A Boundary Clock (BC) acts as a PTP slave to its upstream master clock (e.g., the Grandmaster) and as a PTP master to downstream slave clocks [Diagram in 186].  
The core of a BC's operation involves synchronizing its own internal clock to the received PTP time from the Grandmaster. After synchronizing, the BC re-stamps outgoing PTP messages with its own synchronized internal clock before forwarding them to downstream slaves.

**Potential Jitter:** While BCs aim to maintain high accuracy, the act of synchronizing an internal clock and then re-stamping every PTP message can introduce some level of processing delay and variability. If the internal synchronization of the BC is not perfectly stable, or if its re-stamping process introduces tiny, fluctuating delays, these inaccuracies can manifest as jitter in the downstream PTP messages.  
When dealing with a speed conversion (1Gbps to 100Mbps), the internal buffering and forwarding mechanisms of the switch can experience variations, which a BC must attempt to perfectly account for during re-stamping. Any failure to do so accurately could add jitter.

---

### Transparent Clock (TC) Operation and Jitter Reduction

A Transparent Clock (TC), particularly as defined in PTPv2, operates differently. Instead of synchronizing its own clock and re-stamping messages, a TC measures the residence time (the time a PTP message spends within the switch).  
This measured residence time is then added to the "CorrectionField" within the PTP telegram itself. The original timestamp of the PTP message from the Grandmaster is left undisturbed.

**Jitter Reduction Benefit:**  
Because the TC does not rely on its own internal clock synchronization to re-stamp messages, it avoids introducing potential jitter from its own clock's instability.  
Instead, it simply accounts for the actual packet-specific delay it imposes on the PTP message. This means that the downstream slave (EL6688) receives the original Grandmaster timestamp plus an accumulated, highly accurate compensation for the actual time each packet spent transiting through the network elements (including the Moxa switch).

The source explicitly states that PTPv2 was "extended by many features, for which reason it has been well accepted by the market. From a technical point of view simpler switches with the clock type “Transparent clock” can be used with V2".  
This suggests that TC, particularly in PTPv2, provides an efficient and effective means of achieving high time synchronization accuracy, even with less complex hardware.  
By compensating for network delays through the CorrectionField, Transparent Clocks inherently work to prevent the accumulation of timing errors across network segments, which contributes to lower overall jitter for the end device like the EL6688.

---

### In summary

While both BC and TC aim to improve PTP accuracy, the TC's method of precisely measuring and reporting per-packet delays via the CorrectionField, rather than re-stamping, generally leads to a cleaner and more accurate time synchronization signal at the slave device (EL6688), thus reducing the overall jitter.  
This is particularly advantageous in scenarios involving speed conversions where consistent and precise delay compensation is crucial.
